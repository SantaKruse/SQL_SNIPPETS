
CREATE FUNCTION NHS_NUMBER_CHECK(@NHS_NUMBER AS NVARCHAR(100)) RETURNS NVARCHAR(100)
AS
  BEGIN
    DECLARE @OUT AS NVARCHAR(100)
    SET @NHS_NUMBER = RTRIM(LTRIM(@NHS_NUMBER))
    SET @OUT = 
      CASE
      WHEN @NHS_NUMBER IS NULL THEN 'INVALID NULL'
      WHEN LEN(@NHS_NUMBER) <> 10 THEN 'INVALID INCORRECT LENGTH'  
      WHEN ISNUMERIC(@NHS_NUMBER) = 0 THEN 'INVALID NOT NUMERIC'
      WHEN ISNUMERIC(@NHS_NUMBER + '.0e0') = 0 THEN 'INVALID NOT NUMERIC'
      WHEN
        11 - (((10 * CAST(RIGHT(LEFT(@NHS_NUMBER,1),1) AS INT))+ (9 * CAST(RIGHT(LEFT(@NHS_NUMBER,2),1) AS INT))
         + (8 * CAST(RIGHT(LEFT(@NHS_NUMBER,3),1) AS INT)) + (7 * CAST(RIGHT(LEFT(@NHS_NUMBER,4),1) AS INT))
         + (6 * CAST(RIGHT(LEFT(@NHS_NUMBER,5),1) AS INT)) + (5 * CAST(RIGHT(LEFT(@NHS_NUMBER,6),1) AS INT))
         + (4 * CAST(RIGHT(LEFT(@NHS_NUMBER,7),1) AS INT)) + (3 * CAST(RIGHT(LEFT(@NHS_NUMBER,8),1) AS INT)))
         + (2 * CAST(RIGHT(LEFT(@NHS_NUMBER,9),1) AS INT)) %11) = 11 AND RIGHT(@NHS_NUMBER,1) = '0' THEN 'VALID CHECK DIGIT'
      WHEN
        11 - (((10 * CAST(RIGHT(LEFT(@NHS_NUMBER,1),1) AS INT))+ (9 * CAST(RIGHT(LEFT(@NHS_NUMBER,2),1) AS INT))
         + (8 * CAST(RIGHT(LEFT(@NHS_NUMBER,3),1) AS INT)) + (7 * CAST(RIGHT(LEFT(@NHS_NUMBER,4),1) AS INT))
         + (6 * CAST(RIGHT(LEFT(@NHS_NUMBER,5),1) AS INT)) + (5 * CAST(RIGHT(LEFT(@NHS_NUMBER,6),1) AS INT))
         + (4 * CAST(RIGHT(LEFT(@NHS_NUMBER,7),1) AS INT)) + (3 * CAST(RIGHT(LEFT(@NHS_NUMBER,8),1) AS INT))
         + (2 * CAST(RIGHT(LEFT(@NHS_NUMBER,9),1) AS INT))) %11) = 10 THEN 'INVALID CHECK DIGIT'
      WHEN
        11 - (((10 * CAST(RIGHT(LEFT(@NHS_NUMBER,1),1) AS INT))+ (9 * CAST(RIGHT(LEFT(@NHS_NUMBER,2),1) AS INT))
         + (8 * CAST(RIGHT(LEFT(@NHS_NUMBER,3),1) AS INT)) + (7 * CAST(RIGHT(LEFT(@NHS_NUMBER,4),1) AS INT))
         + (6 * CAST(RIGHT(LEFT(@NHS_NUMBER,5),1) AS INT)) + (5 * CAST(RIGHT(LEFT(@NHS_NUMBER,6),1) AS INT))
         + (4 * CAST(RIGHT(LEFT(@NHS_NUMBER,7),1) AS INT)) + (3 * CAST(RIGHT(LEFT(@NHS_NUMBER,8),1) AS INT))
         + (2 * CAST(RIGHT(LEFT(@NHS_NUMBER,9),1) AS INT))) %11) = RIGHT(@NHS_NUMBER,1) THEN 'VALID CHECK DIGIT'
      ELSE 'INVALID CHECK DIGIT'
      END
    RETURN @OUT
  END